{% extends "base.html" %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- Leaflet Routing Machine -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<style>
    .rider-contact-btn {
        padding: 0.75rem;
        border-radius: 50%;
        background: #dcfce7;
        color: var(--primary-dark);
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .rider-contact-btn[hidden] {
        display: none !important;
        /* Force override if needed */
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="padding-top: 8rem; padding-bottom: 4rem; text-align: center;">
    <h1>Track Your Freshness</h1>

    <!-- Search Form -->
    <div class="card" style="max-width: 600px; margin: 0 auto 2rem; padding: 2rem;">
        <form action="/track" method="POST" style="display: flex; gap: 1rem;">
            <input type="text" name="order_id" placeholder="Enter Order ID (e.g. 1001)" required style="flex: 1;">
            <button type="submit" class="btn btn-primary">Track</button>
        </form>
    </div>

    {% if show_success %}
    <div
        style="background: #dcfce7; color: #166534; padding: 1rem; border-radius: 0.5rem; margin: 0 auto 2rem; max-width: 600px;">
        Order placed successfully! Your Order ID is <strong>{{ order.id }}</strong>.
    </div>
    {% endif %}

    {% if order %}
    <div class="card" style="max-width: 600px; margin: 2rem auto; padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <span style="font-weight: bold; font-size: 1.2rem;">Order #{{ order.id }}</span>
            <span
                style="background: #dcfce7; color: var(--primary-dark); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">{{
                order.status }}</span>
        </div>

        <!-- Map Container -->
        <div
            style="height: 350px; background: #f1f5f9; border-radius: 1rem; margin-bottom: 1.5rem; border: 2px solid var(--border-color); overflow: hidden; position: relative;">
            <div id="map"></div>
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 1.5rem;">
            <div
                style="width: 50px; height: 50px; border-radius: 50%; background: #cbd5e1; margin-right: 1rem; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="user" style="color: grey;"></i>
            </div>
            <div style="text-align: left; flex: 1;">
                {% if order.rider_name %}
                <p style="font-weight: bold; margin-bottom: 0.25rem;">{{ order.rider_name }}</p>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">
                    {{ order.rider_vehicle or 'Motorbike' }} â€¢ {{ order.rider_plate or 'No Plate' }} â€¢ {{
                    order.rider_color or 'Green' }}
                </p>
                <div style="display: flex; align-items: center; gap: 0.25rem;">
                    <span style="color: #f59e0b;">â˜…</span>
                    <span style="font-size: 0.9rem;">4.9</span>
                </div>
                {% else %}
                <p style="font-weight: bold; margin-bottom: 0.25rem;">Finding your rider...</p>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">
                    Please wait while we assign a courier.
                </p>
                {% endif %}
            </div>
            <a id="rider-call-btn" href="{{ 'tel:' + order.rider_phone if order.rider_phone else '#' }}"
                class="btn rider-contact-btn" {% if not order.rider_phone %}hidden{% endif %}>
                <i data-lucide="phone" style="width: 20px;"></i>
            </a>
        </div>

        <p style="font-weight: bold; font-size: 1.2rem; color: var(--text-main);">ETA:
            {{ order.eta if order.eta else 'Calculating...' }}
        </p>
        <div style="height: 4px; background: #e2e8f0; border-radius: 2px; margin-top: 1rem; overflow: hidden;">
            <div style="height: 100%; width: 75%; background: var(--primary);"></div>
        </div>
    </div>
    {% elif request.method == 'POST' %}
    <p>Order not found. Please check the ID and try again.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const mapContainer = document.getElementById('map');
        if (!mapContainer) return; // Exit if map container doesn't exist

        // Safe extraction of coordinates
        // Wrap in quotes to ensure we handle strings/numbers correctly, then parseFloat
        const rawLat = "{{ order.location.lat if order and order.location and order.location.lat else '5.6037' }}";
        const rawLng = "{{ order.location.lng if order and order.location and order.location.lng else '-0.1870' }}";

        const orderLat = parseFloat(rawLat);
        const orderLng = parseFloat(rawLng);

        // Validation - if invalid or 0,0, fall back to Accra default
        // We treat (0,0) as invalid because it's in the ocean and often a default value
        const finalLat = (!isNaN(orderLat) && Math.abs(orderLat) > 0.0001) ? orderLat : 5.6037;
        const finalLng = (!isNaN(orderLng) && Math.abs(orderLng) > 0.0001) ? orderLng : -0.1870;

        // Rider Location Logic
        const serverRiderLat = "{{ order.rider_lat if order and order.rider_lat else '' }}";
        const serverRiderLng = "{{ order.rider_lng if order and order.rider_lng else '' }}";

        let riderLat = parseFloat(serverRiderLat);
        let riderLng = parseFloat(serverRiderLng);

        // Fallback to mock offset if no real location data or 0,0
        // Use epsilon check for float 0
        if (isNaN(riderLat) || isNaN(riderLng) || (Math.abs(riderLat) < 0.0001 && Math.abs(riderLng) < 0.0001)) {
            console.log("Invalid rider location (0,0 or missing), using fallback.");
            riderLat = finalLat + 0.005;
            riderLng = finalLng + 0.005;
        }

        const map = L.map('map').setView([finalLat, finalLng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        function createRiderIcon(type, color) {
            let iconName = 'bike';
            if (type && type.toLowerCase().includes('car')) iconName = 'car';
            if (type && type.toLowerCase().includes('van')) iconName = 'truck';
            if (type && type.toLowerCase().includes('bicycle')) iconName = 'bike';

            // Sanitize color
            if (!color || color === 'None') color = '#16a34a';

            let svg = '';
            // Try to verify valid color by setting a temp element? No, too complex.
            // Just rely on browser parsing.

            if (window.lucide && window.lucide.icons) {
                // Lucide uses PascalCase keys (e.g. 'Car', 'Bike')
                const pascalName = iconName.charAt(0).toUpperCase() + iconName.slice(1);
                const iconNode = window.lucide.icons[pascalName] || window.lucide.icons[iconName];

                if (iconNode) {
                    svg = iconNode.toSvg({
                        color: color,
                        'stroke-width': 2,
                        width: 24,
                        height: 24
                    });
                } else {
                    svg = 'ðŸï¸';
                }
            } else {
                svg = 'ðŸï¸';
            }

            const html = `<div style="background: white; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 2px solid ${color};">
            ${svg}
        </div>`;

            return L.divIcon({
                html: html,
                className: '',
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -20]
            });
        }

        let riderIcon = createRiderIcon(
            "{{ order.rider_vehicle if order and order.rider_vehicle else 'Motorbike' }}",
            "{{ order.rider_color if order and order.rider_color else '#16a34a' }}"
        );

        const homeIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const riderMarker = L.marker([riderLat, riderLng], { icon: riderIcon })
            .addTo(map)
            .bindPopup(`
                <b>Rider:</b> {{ order.rider_name if order and order.rider_name else 'Assigning...' }}<br>
                <b>Vehicle:</b> {{ order.rider_vehicle if order and order.rider_vehicle else 'Motorbike' }}<br>
                <b>Plate:</b> {{ order.rider_plate if order and order.rider_plate else 'Not Listed' }}<br>
                <i>{{ order.status if order and order.status else 'On the way' }}</i>
            `)
            .openPopup();

        L.marker([finalLat, finalLng], { icon: homeIcon })
            .addTo(map)
            .bindPopup("<b>Destination</b><br>{{ order.location.address if order and order.location and order.location.address else 'Delivery Location' }}");

        // Routing Control
        let routingControl = null;

        function updateRoute(startLat, startLng, endLat, endLng) {
            if (!L.Routing) return;

            const start = L.latLng(startLat, startLng);
            const end = L.latLng(endLat, endLng);

            if (routingControl) {
                routingControl.setWaypoints([start, end]);
            } else {
                routingControl = L.Routing.control({
                    waypoints: [start, end],
                    lineOptions: {
                        styles: [{ color: '#16a34a', opacity: 0.8, weight: 6 }]
                    },
                    createMarker: function () { return null; }, // Hide default markers
                    addWaypoints: false,
                    draggableWaypoints: false,
                    fitSelectedRoutes: false,
                    show: false, // Try to hide default container
                    containerClassName: 'routing-hidden' // Custom class to hide
                }).addTo(map);

                // Hide the panel via CSS if show:false doesn't work
                const container = document.querySelector('.leaflet-routing-container');
                if (container) container.style.display = 'none';
            }
        }

        // Simpler function to update route on move
        function refreshRoute() {
            if (riderMarker) {
                const rPos = riderMarker.getLatLng();
                updateRoute(rPos.lat, rPos.lng, finalLat, finalLng);
            }
        }

        // Fit bounds to show both
        const group = new L.featureGroup([
            riderMarker,
            L.marker([finalLat, finalLng])
        ]);
        map.fitBounds(group.getBounds().pad(0.2));

        // Initial Route
        refreshRoute();

        // Simulate Real-time Movement (Demo)
        // Real-time Tracking via Socket.IO
        const socket = io();
        const orderId = "{{ order.id }}";

        socket.on('connect', () => {
            console.log("Connected to Tracker");
            socket.emit('join_order', { order_id: orderId });
        });

        socket.on('status_update', (data) => {
            // Update Status Badge
            const statusEl = document.querySelector('span[style*="background: #dcfce7"]');
            if (statusEl) statusEl.innerText = data.status;

            // Update Rider Info if assigned
            if (data.rider) {
                const riderNameEl = document.querySelector('p[style*="font-weight: bold; margin-bottom: 0.25rem;"]');
                if (riderNameEl) {
                    riderNameEl.innerText = data.rider;

                    // Update Vehicle/Plate if available (assuming it's the next sibling p tag)
                    if (data.vehicle || data.plate) {
                        const infoEl = riderNameEl.nextElementSibling;
                        if (infoEl && infoEl.tagName === 'P') {
                            const vehicle = data.vehicle || 'Motorbike';
                            const plate = data.plate || 'No Plate';
                            const color = data.color || 'Green';
                            infoEl.innerText = `${vehicle} â€¢ ${plate} â€¢ ${color}`;

                            // Update Map Icon
                            const newIcon = createRiderIcon(vehicle, color);
                            if (riderMarker) {
                                riderMarker.setIcon(newIcon);
                            }
                        }
                    }

                    // Update Phone
                    if (data.phone) {
                        const callBtn = document.getElementById('rider-call-btn');
                        if (callBtn) {
                            callBtn.href = `tel:${data.phone}`;
                            callBtn.style.display = 'flex';
                        }
                    }
                }
            }

            // Update Progress Bar (Simple Logic)
            const progress = document.querySelector('div[style*="width: 75%"]');
            if (progress) {
                if (data.status === 'Rider Assigned') progress.style.width = '25%';
                else if (data.status === 'Arrived at Pickup') progress.style.width = '50%';
                else if (data.status === 'Picked Up') progress.style.width = '75%';
                else if (data.status === 'Delivered') progress.style.width = '100%';
            }

            // Refresh map data (fallback to fetch for full details)
            refreshMap();
        });

        socket.on('location_update', (data) => {
            console.log("Rider moved (socket):", data);

            // Visual Debug Indicator (Optional)
            const statusBadge = document.querySelector('span[style*="background: #dcfce7"]');
            if (statusBadge) {
                const originalText = statusBadge.innerText;
                statusBadge.innerText = "ðŸ“ Updating...";
                setTimeout(() => statusBadge.innerText = originalText, 500);
            }

            if (riderMarker) {
                const newLat = parseFloat(data.lat);
                const newLng = parseFloat(data.lng);

                if (!isNaN(newLat) && !isNaN(newLng)) {
                    // Animate marker movement
                    riderMarker.setLatLng([newLat, newLng]);
                    refreshRoute();
                }
            }
        });

        async function refreshMap() {
            try {
                const res = await fetch(`/api/order/${orderId}/track`);
                const data = await res.json();

                if (data.rider && data.rider.lat && data.rider.lng) {
                    const newLat = parseFloat(data.rider.lat);
                    const newLng = parseFloat(data.rider.lng);
                    riderMarker.setLatLng([newLat, newLng]);

                    // Update Popup
                    const vehicle = data.rider.vehicle || 'Motorbike';
                    const plate = data.rider.plate || 'No Plate';
                    const color = data.rider.color || 'Green';

                    riderMarker.getPopup().setContent(`
                        <b>Rider:</b> ${data.rider.name}<br>
                        <b>Vehicle:</b> ${vehicle}<br>
                        <b>Plate:</b> ${plate}<br>
                        <i>${data.status}</i>
                    `);

                    // Update Icon if needed (optional)
                    const newIcon = createRiderIcon(vehicle, color);
                    riderMarker.setIcon(newIcon);

                    // Update Phone
                    if (data.rider.phone) {
                        const callBtn = document.getElementById('rider-call-btn');
                        if (callBtn) {
                            callBtn.href = `tel:${data.rider.phone}`;
                            callBtn.style.display = 'flex';
                        }
                    }
                }
            } catch (e) {
                console.error("Tracking Error:", e);
            }
        }

    });
</script>
{% endblock %}