{% extends "base.html" %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}

{% block content %}
<div class="container" style="padding-top: 8rem; padding-bottom: 4rem; text-align: center;">
    <h1>Track Your Freshness</h1>

    <!-- Search Form -->
    <div class="card" style="max-width: 600px; margin: 0 auto 2rem; padding: 2rem;">
        <form action="/track" method="POST" style="display: flex; gap: 1rem;">
            <input type="text" name="order_id" placeholder="Enter Order ID (e.g. 1001)" required style="flex: 1;">
            <button type="submit" class="btn btn-primary">Track</button>
        </form>
    </div>

    {% if show_success %}
    <div
        style="background: #dcfce7; color: #166534; padding: 1rem; border-radius: 0.5rem; margin: 0 auto 2rem; max-width: 600px;">
        Order placed successfully! Your Order ID is <strong>{{ order.id }}</strong>.
    </div>
    {% endif %}

    {% if order %}
    <div class="card" style="max-width: 600px; margin: 2rem auto; padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <span style="font-weight: bold; font-size: 1.2rem;">Order #{{ order.id }}</span>
            <span
                style="background: #dcfce7; color: var(--primary-dark); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">{{
                order.status }}</span>
        </div>

        <!-- Map Container -->
        <div
            style="height: 350px; background: #f1f5f9; border-radius: 1rem; margin-bottom: 1.5rem; border: 2px solid var(--border-color); overflow: hidden; position: relative;">
            <div id="map"></div>
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 1.5rem;">
            <div
                style="width: 50px; height: 50px; border-radius: 50%; background: #cbd5e1; margin-right: 1rem; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="user" style="color: grey;"></i>
            </div>
            <div style="text-align: left; flex: 1;">
                <p style="font-weight: bold; margin-bottom: 0.25rem;">{{ order.rider }}</p>
                <div style="display: flex; align-items: center; gap: 0.25rem;">
                    <span style="color: #f59e0b;">â˜…</span>
                    <span style="font-size: 0.9rem;">4.9</span>
                </div>
            </div>
            <button class="btn"
                style="padding: 0.75rem; border-radius: 50%; background: #dcfce7; color: var(--primary-dark);">
                <i data-lucide="phone" style="width: 20px;"></i>
            </button>
        </div>

        <p style="font-weight: bold; font-size: 1.2rem; color: var(--text-main);">ETA: {{ order.eta }}</p>
        <div style="height: 4px; background: #e2e8f0; border-radius: 2px; margin-top: 1rem; overflow: hidden;">
            <div style="height: 100%; width: 75%; background: var(--primary);"></div>
        </div>
    </div>
    {% elif request.method == 'POST' %}
    <p>Order not found. Please check the ID and try again.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const mapContainer = document.getElementById('map');
        if (!mapContainer) return; // Exit if map container doesn't exist

        // Safe extraction of coordinates
        // Wrap in quotes to ensure we handle strings/numbers correctly, then parseFloat
        const rawLat = "{{ order.location.lat if order and order.location and order.location.lat else '5.6037' }}";
        const rawLng = "{{ order.location.lng if order and order.location and order.location.lng else '-0.1870' }}";

        const orderLat = parseFloat(rawLat);
        const orderLng = parseFloat(rawLng);

        // Validation - if invalid fall back to Accra default
        const finalLat = isNaN(orderLat) ? 5.6037 : orderLat;
        const finalLng = isNaN(orderLng) ? -0.1870 : orderLng;

        // Rider Location Logic
        const serverRiderLat = "{{ order.rider_lat if order and order.rider_lat else '' }}";
        const serverRiderLng = "{{ order.rider_lng if order and order.rider_lng else '' }}";

        let riderLat = parseFloat(serverRiderLat);
        let riderLng = parseFloat(serverRiderLng);

        // Fallback to mock offset if no real location data
        if (isNaN(riderLat) || isNaN(riderLng)) {
            riderLat = finalLat + 0.005;
            riderLng = finalLng + 0.005;
        }

        const map = L.map('map').setView([finalLat, finalLng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // Icons
        const riderIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const homeIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // Add Markers
        const riderMarker = L.marker([riderLat, riderLng], { icon: riderIcon })
            .addTo(map)
            .bindPopup("<b>Rider:</b> {{ order.rider_name if order and order.rider_name else 'Assigning...' }}<br><i>{{ order.status if order and order.status else 'On the way' }}</i>")
            .openPopup();

        L.marker([finalLat, finalLng], { icon: homeIcon })
            .addTo(map)
            .bindPopup("<b>Destination</b><br>{{ order.location.address if order and order.location and order.location.address else 'Delivery Location' }}");

        // Fit bounds to show both
        const group = new L.featureGroup([
            riderMarker,
            L.marker([finalLat, finalLng])
        ]);
        map.fitBounds(group.getBounds().pad(0.2));

        // Simulate Real-time Movement (Demo)
        // Real-time Tracking via Socket.IO
        const socket = io();
        const orderId = "{{ order.id }}";

        socket.on('connect', () => {
            console.log("Connected to Tracker");
            socket.emit('join_order', { order_id: orderId });
        });

        socket.on('status_update', (data) => {
            // Update Status Badge
            const statusEl = document.querySelector('span[style*="background: #dcfce7"]');
            if (statusEl) statusEl.innerText = data.status;

            // Update Rider Info if assigned
            if (data.rider) {
                const riderNameEl = document.querySelector('p[style*="font-weight: bold; margin-bottom: 0.25rem;"]');
                if (riderNameEl) riderNameEl.innerText = data.rider;
            }

            // Update Progress Bar (Simple Logic)
            const progress = document.querySelector('div[style*="width: 75%"]');
            if (progress) {
                if (data.status === 'Rider Assigned') progress.style.width = '25%';
                else if (data.status === 'Arrived at Pickup') progress.style.width = '50%';
                else if (data.status === 'Picked Up') progress.style.width = '75%';
                else if (data.status === 'Delivered') progress.style.width = '100%';
            }

            // Refresh map data (fallback to fetch for full details)
            refreshMap();
        });

        socket.on('location_update', (data) => {
            console.log("Rider moved (socket):", data);

            // Visual Debug Indicator (Optional)
            const statusBadge = document.querySelector('span[style*="background: #dcfce7"]');
            if (statusBadge) {
                const originalText = statusBadge.innerText;
                statusBadge.innerText = "ðŸ“ Updating...";
                setTimeout(() => statusBadge.innerText = originalText, 500);
            }

            if (riderMarker) {
                const newLat = parseFloat(data.lat);
                const newLng = parseFloat(data.lng);

                if (!isNaN(newLat) && !isNaN(newLng)) {
                    // Animate marker movement
                    riderMarker.setLatLng([newLat, newLng]);
                }
            }
        });

        async function refreshMap() {
            try {
                const res = await fetch(`/api/order/${orderId}/track`);
                const data = await res.json();

                if (data.rider && data.rider.lat && data.rider.lng) {
                    const newLat = parseFloat(data.rider.lat);
                    const newLng = parseFloat(data.rider.lng);
                    riderMarker.setLatLng([newLat, newLng]);
                    riderMarker.getPopup().setContent(`<b>Rider:</b> ${data.rider.name}<br><i>${data.status}</i>`);
                }
            } catch (e) {
                console.error("Tracking Error:", e);
            }
        }

    });
</script>
{% endblock %}